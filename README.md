Azure Plugin
============

The purpose of the plugin is to develop, test and publish Azure ATM templates within a context of gradle project. The ARM templates will be uploaded into an Azure storage Account for using. This enables the deploy of ARM templates, that calls sub templates or other artefacts defined in the project before the commit in any VCS.

Use `azureTestDeploy` for uploading a template folder into a given storage account ad deploying the templates from there into a test resource group. `azureCleanTestEnvironment` can ve used, for deleting the templates and the resource again. Both tasks will be called from `azureTest` for executing tests, defined in provided sourceSet `azureTest`. Use `azurePublish` for uploadin the templates into a BlobContainer of the storage account with a name, ralated to the project into a "version" subfolder.           

Setup
-----

### Preconditions

You have to provide a storage account for uploading the templates and a service principal for creating resources within a given subscription and to work with the storage account. 

### Configuration

Each configuration value can be confuiugred with using a environment variable or a project roperty. All configurations are listed in the following table.
  
| Environment                | Property                 | Default             | Description |
|----------------------------|--------------------------|---------------------|-------------|
| AZURE_CLIENT_ID            | azureClientId            |                     | Azure login data of an service principal |
| AZURE_CLIENT_DOMAIN        | azureClientDomain        |                     | Azure login data of an service principal |
| AZURE_CLIENT_SECRET        | azureClientSecret        |                     | Azure login data of an service principal |
| AZURE_SUBSCRIPTION_ID      | azureSubscriptionId      |                     | Azure subscription for creating the test Deploymnets  |
| AZURE_PROJECT_NAME         | azureProjectName         | project.getName()   | A valid domain name is recommended. |
| AZURE_WORKSPACE_ID_PREFIX  | azureWorkspaceIdPrefix   | test                | Used i.e for generating the test resourcegroup name. A generated `workspaceId` has the structure `<prefix>-<projectName>-<a random number>` and equal for the hold livecycle of the build directory.  |
| AZURE_RESOURCEGROUP_REGION | azureResourceGroupRegion | northeurope         |  |
| AZURE_STORAGE_ID           | azureStorageId           |                     | storage account for storing ARM templates. |
| AZURE_STORAGE_CONTAINER    | azureStorageContainer    | templates           | storage container for storing the ARM templates |
| AZURE_TEMPLATE_SRC_DIR     | azureTemplateSrcDir      | src/azure/templates | template source folder - relative to project.getRootDir() |
| AZURE_TEMPLATE_BUILD_DIR   | azureTemplateBuildDir      | azure/templates | template build folder - relativ to project.getBuildDir |
| AZURE_BUILD_VERSION        | azureBuildVersion        |  | Version string, used for publishing the arm templates into the storage account. |


### Registering Deployments

Within the build.gradle, you can use the method `azure.addDeployment(id, template_name, parameter_name)` for add or replace a deploymentTask. By default, a deployment `('azuredeploy', 'azuredeploy.json', 'azuredeploy.parameters.json')`is already registered.
 
Usage
-----

Here are the most important tasks and theirs outcome: 

### testwise deployment: (`azureTestDeploy`)

* `azureBuild` was called for copying `azureTemplateSrcDir` into `azureTemplateBuildDir`. You can add further action action to 'azureBuild' for further preparations of the build folder.
* a BlobContainer with name `<azureProjectName>` will be created, if not exist (`getBlobContainer`)  
* the `azureTemplateBuildDir` is uploaded into the Blob `<azureProjectName>\<workspaceId>` (`uploadARMTemplates`)    
* a resource group with name '<workspaceId>' is created (`createTestResourceGroup`)
* all defined deployments are executed (`azureTestDeploy_<id>`).

### cleanup test resources ('cleanTestEnvironment')

* all resources/artefacts, generated by `createTestResourceGroup`, `uploadARMTemplates` or `prepareTestEnvironment` will deleted.   

### testing at azure ('azureTest')

* `azureTestDeploy` is called
* Inormation about access to the test resource group and the outcome of all deployments are stored temporary and available for tests 
* tests, defined in the azureTest sourceSet are executed

### publishing ('azurePublish')

* the task will be skipped, if the Blob `<azureProjectName>\<azureBuildVersion>` already exist.
* `azureTest` is called
* `azureTemplateBuildDir` is uploaded into a Blob `<azureProjectName>\<azureBuildVersion>`. 

### defined tasks

![tasks](misc/tasks.gif)







